const { cmd } = require('../command');
const axios = require('axios');
const FormData = require('form-data');
const fs = require('fs');
const path = require('path');
const os = require('os');

/**
 * Aha-Music (doreso.com) API integration
 * @param {string} filePath Path to the temporary audio file.
 */
async function aha_music(filePath) {
    const form = new FormData();
    form.append('file', fs.createReadStream(filePath));
    form.append('sample_size', 118784);
    
    const { data } = await axios.post(
        'https://api.doreso.com/humming', 
        form, 
        {
            headers: {
                ...form.getHeaders(),
                'user-agent': 'Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Mobile Safari/537.36',
                'accept': 'application/json, text/plain, */*',
                'origin': 'https://www.aha-music.com',
                'referer': 'https://www.aha-music.com/'
            },
            maxBodyLength: Infinity,
            maxContentLength: Infinity
        }
    );
    return data;
}

cmd({
    pattern: "findsong",
    alias: ["shazam", "whatsong", "musicfind"],
    react: "ğŸ¶",
    desc: "Identify a song title by replying to an audio or voice message.",
    category: "tools",
    filename: __filename
},           
async (conn, mek, m, { from, reply, quoted }) => {
    let tmpPath = null;
    try {
        // 1. Ø¢ÚˆÛŒÙˆ Ú†ÛŒÚ© Ú©Ø±ÛŒÚº (LID Safe logic)
        const quotedMsg = quoted || m;
        const mime = (quotedMsg.msg || quotedMsg).mimetype || "";

        if (!/audio|video/.test(mime)) {
            return reply("âš ï¸ Please reply to an *audio*, *voice note*, or *video* to identify the song.");
        }

        await conn.sendMessage(from, { react: { text: "â³", key: m.key } });

        // 2. Ù…ÛŒÚˆÛŒØ§ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº
        const buffer = await conn.downloadMediaMessage(quotedMsg);
        if (!buffer) return reply("âŒ Failed to download media.");

        // 3. Ø¹Ø§Ø±Ø¶ÛŒ ÙØ§Ø¦Ù„ (Temporary File) Ø¨Ù†Ø§Ø¦ÛŒÚº
        tmpPath = path.join(os.tmpdir(), `find_${Date.now()}.mp3`);
        fs.writeFileSync(tmpPath, buffer);

        // 4. Shazam/Aha API Ú©Ø§Ù„ Ú©Ø±ÛŒÚº
        const result = await aha_music(tmpPath);

        // 5. Ø±Ø²Ù„Ù¹ ÛÛŒÙ†ÚˆÙ„Ù†Ú¯ Ø§ÙˆØ± Ù…ÛŒØ³Ø¬Ù†Ú¯
        if (result && result.data && result.data.title) {
            const { title, artists } = result.data;
            const caption = `ğŸµ *SONG IDENTIFIED!* ğŸµ\n\n` +
                          `ğŸ“Œ *Title:* ${title}\n` +
                          `ğŸ‘¤ *Artist:* ${artists}\n\n` +
                          `*Generated by Knight-Bot (Aha-Music)*`;
            
            await conn.sendMessage(from, { text: caption }, { quoted: mek });
            await conn.sendMessage(from, { react: { text: "âœ…", key: m.key } });
        } else {
            await conn.sendMessage(from, { react: { text: "â“", key: m.key } });
            reply("âŒ Song not found. Try a clearer or longer audio sample (minimum 5-10 seconds).");
        }

    } catch (err) {
        console.error("Identification Error:", err);
        await conn.sendMessage(from, { react: { text: "âŒ", key: m.key } });
        reply(`âŒ Error: ${err.message || "Something went wrong during identification."}`);
    } finally {
        // 6. Ø³Ø±ÙˆØ± Ø³Û’ Ø¹Ø§Ø±Ø¶ÛŒ ÙØ§Ø¦Ù„ ÚˆÛŒÙ„ÛŒÙ¹ Ú©Ø±ÛŒÚº (Cleanup)
        if (tmpPath && fs.existsSync(tmpPath)) {
            fs.unlinkSync(tmpPath);
        }
    }
});
